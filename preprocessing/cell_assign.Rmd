---
title: "Assign cell types using cellAssign"
output:
  html_notebook:
    toc: yes
    number_sections: yes
    toc_float: no
  html_document:
    number_sections: yes
    toc: yes
    toc_float: yes
  pdf_document:
    number_sections: yes
    toc: yes
---


```{r}
suppressPackageStartupMessages({
  library(Seurat)
  library(tensorflow)
  library(cellassign)
  library(pheatmap)
  library(here)
  library(scater)
})
```

```{r}
set.seed(1234)                # set R rng seed
reticulate::py_set_seed(1234) # set python rng seed
```



# Load 10X scRNA-seq data from csv files

```{r}
data_dir <- here('data_qc')
```

```{r}
load_dataset <- function(file, name) {
    print(paste0('Loading dataset ', file))
    count_matrix.data <- read.csv(file, row.names=1)  # Load csv file
    # Create Seurat object
    count_matrix <- CreateSeuratObject(counts = count_matrix.data, project=name)
    print(cat(name, dim(count_matrix)))
    return(count_matrix)
}
```

Load HOM datasets (counts) after removal of unwanted cells from quality control - but before normalisation

```{r}
E13_hom <- load_dataset(file.path(data_dir, 'E13_hom.csv'), 'E13_hom')
E13_hom.data <- as.SingleCellExperiment(E13_hom, assay = 'RNA')  # Convert to SingleCellExperiment class

E14_hom <- load_dataset(file.path(data_dir, 'E14_hom.csv'), 'E14_hom')
E14_hom.data <- as.SingleCellExperiment(E14_hom, assay = 'RNA')  # Convert to SingleCellExperiment class
```


```{r}
E13_het <- load_dataset(file.path(data_dir, 'E13_het.csv'), 'E13_het')
E13_het.data <- as.SingleCellExperiment(E13_het)  # Convert to SingleCellExperiment class

E14_het <- load_dataset(file.path(data_dir, 'E14_het.csv'), 'E14_het')
E14_het.data <- as.SingleCellExperiment(E14_het)  # Convert to SingleCellExperiment class

```

# Assign cells to known cell types using cellassign

There are three major cell types in these datasets:

1. **Neural progenitors**, marker *Pax6* --> cells that are capable of dividing a limited number of times and have the capacity to differentiate into a restricted repertoire of neuronal and glial cell types.

2. **Intermediate progenitors**, marker *Eomes* --> a type of progenitor cells in the developing cerebral cortex, which produce neuron cells via a process known as neurogenesis. I

3. **Post-mitotic neurons**, marker *Tbr1* --> mature cells that no longer undergo mitosis.

```{r}
marker_list <- list(
    `Intermediate progenitors` = c('Eomes', 'Btg2'),
    `Post-mitotic neurons` = c('Tbr1', 'Sox5'),
    `Ectopic cells` = c('Gsx2', 'Prdm13', 'Dlx1', 'Dlx2', 'Dlx5', 'Gad1', 'Gad2', 'Ptf1a', 'Msx3', 'Helt', 'Olig3'),
    `Neural progenitors` = c('Pax6', 'Vim', 'Sox2')
)
```


Binary gene-by-celltype marker gene matrix

```{r fig.width=7, fig.height=5}
mgi <- marker_list_to_mat(marker_list, include_other = FALSE)
pheatmap(mgi)
```



## E13_HOM dataset

Call `cellassign` passing the seurat object, marker info, the size factors

```{r}
fit_E13_hom <- em_result <- cellassign(E13_hom.data[rownames(mgi),],
                                       marker_gene_info = mgi,
                                       s = colSums(SummarizedExperiment::assay(E13_hom.data, "counts")),
                                       shrinkage = TRUE,
                                       verbose = FALSE)
```


Add the cell types to the data object and visualize the probabilities of assignment using the cellprobs function that returns a probability matrix for each cell and cell type:

```{r}
E13_hom.data$cell_type <- fit_E13_hom$cell_type
plotUMAP(E13_hom.data, colour_by = 'cell_type')
```

```{r fig.width=7, fig.height=10}
pheatmap(cellprobs(fit_E13_hom))
```



## E14_HOM dataset


```{r}
fit_E14_hom <- em_result <- cellassign(E14_hom.data[rownames(mgi),],
                                       marker_gene_info = mgi,
                                       s = colSums(SummarizedExperiment::assay(E14_hom.data, "counts")),
                                       shrinkage = TRUE,
                                       verbose = FALSE)
```

```{r}
E14_hom.data$cell_type <- fit_E14_hom$cell_type
plotUMAP(E14_hom.data, colour_by = 'cell_type')
```


```{r fig.width=7, fig.height=10}
pheatmap(cellprobs(fit_E14_hom))
```


## E13_HET dataset

```{r}
fit_E13_het <- em_result <- cellassign(E13_het.data[rownames(mgi),],
                                       marker_gene_info = mgi,
                                       s = colSums(SummarizedExperiment::assay(E13_het.data, "counts")),
                                       shrinkage = TRUE,
                                       verbose = FALSE)
```


```{r}
E13_het.data$cell_type <- celltypes(fit_E13_het)
plotUMAP(E13_het.data, colour_by = 'cell_type')
```

```{r fig.width=7, fig.height=9}
pheatmap(cellprobs(fit_E13_het))
```


## E14_HET dataset

```{r}
fit_E14_het <- em_result <- cellassign(E14_het.data[rownames(mgi),],
                                       marker_gene_info = mgi,
                                       s = colSums(SummarizedExperiment::assay(E14_het.data, "counts")),
                                       shrinkage = TRUE,
                                       verbose = FALSE)
```


```{r}
E14_het.data$cell_type <- fit_E14_het$cell_type
plotUMAP(E14_het.data, colour_by = 'cell_type')
```

```{r fig.width=7, fig.height=10}
pheatmap(cellprobs(fit_E14_het))
```


# Write annotations to a csv file

```{r}
write_to_csv = function(sc_object, csv_name) {
    df = data.frame(umi = colnames(sc_object),
                    cell_type = sc_object[['cell_type']])
    filepath = here('data_qc', csv_name)
    write.csv(df, filepath, row.names = F)
}
```


```{r}
write_to_csv(E13_hom.data, 'anno_E13_hom.csv')
write_to_csv(E14_hom.data, 'anno_E14_hom.csv')
```