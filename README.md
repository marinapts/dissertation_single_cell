# Single-cell analysis

Single-cell analysis pipeline to detect ectopic cells that appear after inactivation of the Pax6 gene
in the cerebral cortex of mouse embryos.

We have gene expression values in single cells for the embryonic days E13 and E14 for controls and knockouts.

> Knockouts (*Homozygous mutant*): `E13_hom`, `E14_hom`

> Controls (*Heterozygous control*): `E13_het`, `E14_het`


### Preprocessing
Preprocess datasets that exist under the data directory. New h5ad files (all genes or only highly variable genes)
are saved in *ann_data*. Run the bash script OR the python file directly by passing the arguments.

Preprocessing includes the following steps:
1. Quality control
2. Normalisation
3. Regression of unwanted variation (cell cycle)
4. PCA
5. UMAP
6. Marker genes for 3 major cell types (Neural progenitors, Intermediate progenitors, Post-mitotic neuron) and ectopic


```console
bash scripts/preprocess.sh
```

```console
python scanpy_preprocess/preprocess.py --dataset E14_hom E13_hom --keep_only_highly_variable --write_to_file
```

Setting the flag `--keep_only_highly_variable` produces the files `ann_data/E1*_hom_variable_genes.h5ad`, otherwise
it produces `ann_data/E1*_hom_all_genes.h5ad`.

### Data Integration - HOMs

```console
bash scripts/integration.sh
```
or

```python
python scanpy_preprocess/integration.py --dataset_type variable --write_to_file
```

### Differential expression and cell-type annotation on initial data
The ranked list of the genes found by DE are saved in the files under *cellmarker*.

```console
bash scripts/marker_genes.sh
```

or

```console
 python scanpy_preprocess/marker_genes.py --dataset E14_hom E14_hom --dataset_type variable  --update_file
```

### Analysis of the AE bottleneck
The input is the csv file with the 32 dimensions of the bottleneck, generated by `scDeepCluster/cluster.sh`.

```console
 bash scripts/bottleneck.sh
```

or

```console
python analyse_bottleneck.py --dataset E14_hom --dataset_type variable --kmeans
```


### Create custom list of cell markers from the CellMarker DB
Creates the *custom_cell_marker_db.csv* cell marker file. To be used SCSA?

```console
 python cellmarker/process_cellmarker_db.py
```

```console
cd cellmarker
python SCSA.py -d whole.db -i DE_E14_hom_variable_genes.csv -s scanpy -E -f1.5 -p 0.05 -o result -m txt -g Mouse -k Brain -M custom_cell_marker_db.csv
```


### scDeepCluster
`scDeepCluster/train.sh`
`scDeepCluster/cluster.sh`

We train on the preprocessed data and generate a csv file containing the latent space representation of the scDeepCluster
model. Bottleneck has size 32. We plot it using UMAP. Ectopic cells are still not visible in E13_HOM.

### Analyse bottleneck of scDeepCluster
`scDeepCluster/latent_space_HOMs.ipynb`

Uses the csv files with the annotations that were generated by `preprocessing/assign_cell_types.R`
